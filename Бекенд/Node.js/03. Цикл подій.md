# Цикл подій (Event Loop)

Event Loop — це механізм, який дозволяє Node.js виконувати неблокуючі операції введення-виведення, незважаючи на те, що JavaScript є однопотоковою мовою.

## Фази циклу подій

- Таймери — виконання колбеків, запланованих за допомогою `setTimeout()` та `setInterval()`.
- I/O колбеки — виконання майже всіх колбеків, за винятком подій `close`, таймерів та `setImmediate()`.
- Очікування, підготовка — використовується для внутрішніх цілей.
- Опитування — отримання нових подій введення/виведення. Node.js може блокуватись на цьому етапі.
- Перевірка — колбеки, викликані `setImmediate()`, викликаються на цьому етапі.
- Коллбеки події `close` — наприклад, `socket.on('close', ...)`;

```
   ┌────────────────────────┐
┌─>│        таймери         │
│  └──────────┬─────────────┘
│  ┌──────────┴─────────────┐
│  │       I/O колбеки      │
│  └──────────┬─────────────┘
│  ┌──────────┴─────────────┐
│  │ очікування, підготовка │
│  └──────────┬─────────────┘      ┌───────────────┐
│  ┌──────────┴─────────────┐      │  вхідні:      │
│  │       опитування       │<─────┤  з'єднання,   │
│  └──────────┬─────────────┘      │  дані, и т.д. │
│  ┌──────────┴─────────────┐      └───────────────┘
│  │       перевірка        │
│  └──────────┬─────────────┘
│  ┌──────────┴─────────────┐
└──┤     колбеки `close`    │
   └────────────────────────┘
```

## Звідки беруться асинхронні операції

- Робота з файлами.
- Читання/запис даних по мережі.
- Відкладені операції.
- Очікування введення користувача.

## Навіщо потрібний `setImmediate()`

- Дає можливість виконати код у межах одного витка, але після спрацьовування обробника.
- Дозволяє розділити підписку та виклик початкової події.

## Відмінності `setImmediate()` від `process.nextTick()`

- `process.nextTick()` — просто переносить виконання в кінець поточної фази.
- `setImmediate()` — переносить виконання в кінець наступного циклу подій.

## Події `close`

- Функції, що викликаються після завершення програми.
- Дозволяють завершити незавершені дії, такі як видалення тимчасових файлів або закриття з'єднань.

## Блокування циклу подій

Оскільки Node.js працює в одному потоці, блокування циклу обробки подій означає блокування всього. Кілька дій, які можуть спричинити простій:

- Дорогі синхронні операції (File System DNS, Crypto, Zlib).
- Синхронні операції, що залежать від вхідних даних.
- Серіалізація/десеріалізація даних (JSON.stringify, JSON.parse).
- Спроби виконати підсвічування синтаксису для великого файлу.
- Парсинг великої порції вихідних даних.
- Регулярні вирази (швидкість роботи залежить від вхідних даних).

## Методи боротьби з блокуванням циклу подій

- Зменшення обчислювальної складності операцій.
- Розділ великих синхронних операцій на кілька маленьких асинхронних.
- Винесення довгих операцій в окремий процес (offloading).
- Знання бібліотек, які використовуються у проекті та їхньої роботи.
