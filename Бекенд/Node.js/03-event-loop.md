## Event loop (цикл подій)

Event loop — це те, що дозволяє Node.js виконувати неблокуючі операції введення-виведення — незважаючи на те, що JavaScript є однопоточним

### Фази циклу подій

-   Таймери: у цій фазі виконуються коллбеки, заплановані setTimeout()та setInterval();
-   I/O коллбеки: виконуються майже всі коллбеки, за винятком подій close, таймерів та setImmediate();
-   Очікування, підготовка: використовується лише для внутрішніх цілей;
-   Опитування: отримання нових подій введення/виведення. Node.js може блокуватись на цьому етапі;
-   Перевірка: коллбеки, викликані setImmediate(), викликаються цьому етапі;
-   Коллбеки події close: наприклад, socket.on('close', ...);

```
   ┌────────────────────────┐
┌─>│        таймери         │
│  └──────────┬─────────────┘
│  ┌──────────┴─────────────┐
│  │       I/O колбеки      │
│  └──────────┬─────────────┘
│  ┌──────────┴─────────────┐
│  │ очікування, підготовка │
│  └──────────┬─────────────┘      ┌───────────────┐
│  ┌──────────┴─────────────┐      │  вхідні:      │
│  │       опитування       │<─────┤  з'єднання,   │
│  └──────────┬─────────────┘      │  дані, и т.д. │
│  ┌──────────┴─────────────┐      └───────────────┘
│  │       перевірка        │
│  └──────────┬─────────────┘
│  ┌──────────┴─────────────┐
└──┤     колбеки `close`    │
   └────────────────────────┘
```

### Звідки беруться асинхронні операції

-   Робота з файлами
-   Читання/запис даних по мережі
-   Відкладені операції
-   Очікування введення користувача

### Навіщо потрібний setImmediate()

-   Дає можливість виконати код у межах одного витка, але після спрацьовування обробника
-   Дозволяє розділити підписку та виклик початкової події

### Відмінності setImmediate() від process.nextTick()

-   process.nextTick просто переносить виконання в кінець поточної фази
-   setImmediate переносить виконання в кінець наступного циклу

### Close events

-   Функції, що викликаються після завершення програми
-   Дозволяють доробити якісь незавершені дії
    -   Видалити тимчасові файли
    -   Коректно закрити з'єднання
    -   Вивести причину закриття програми у консоль

### Блокування event loop

Оскільки Node.js працює в одному потоці, блокування циклу обробки подій означає блокування всього. Ось кілька дій, які можуть стати причиною простою

-   Дорогі синхронні операції (File System DNS, Crypto, Zlib)
-   Синхронні операції, що залежать від вхідних даних
-   Серіалізація/десеріалізація даних (JSON.stringify, JSON.parse)
-   Спроба зробити підсвічування синтаксису для великого файлу за допомогою Ace або highlight.js
-   Парсинг великої порції вихідних даних, наприклад, виведення команди git log із дочірнього процесу
-   Регулярні вирази (швидкість роботи залежить від вхідних даних)

### Методи боротьби з блокуванням event loop

- Зменшення операції
- Поділ великих синхронних операцій на кілька маленьких асинхронних
- Винесення довгих операцій в окремий процес (offloading)
- Знання бібліотек, які використовуються у проекті та як вони працюють
